# assign-to-copilot.yml
# GitHub Issueì— 'ai-copilot' ë¼ë²¨ì´ ë¶™ìœ¼ë©´ ìë™ìœ¼ë¡œ Copilot Coding Agentì— í• ë‹¹
#
# ì„¤ì • ë°©ë²•:
#   1. repo scope PATë¥¼ COPILOT_ASSIGN_TOKEN ì‹œí¬ë¦¿ì— ë“±ë¡
#      bash scripts/copilot-setup-workflow.sh
#   2. ì´ìŠˆì— 'ai-copilot' ë¼ë²¨ ë¶€ì°© â†’ Copilotì´ ìë™ ì‘ì—… ì‹œì‘
#
# planview í†µí•©:
#   planviewë¡œ ì´ìŠˆ ìŠ¤í™ ê²€í†  â†’ ìŠ¹ì¸ í›„ ë¼ë²¨ ë¶€ì°© â†’ ì´ ì›Œí¬í”Œë¡œ ì‹¤í–‰

name: Assign issue to Copilot Coding Agent

on:
  issues:
    types: [opened, labeled]

jobs:
  assign-to-copilot:
    name: Assign to Copilot
    runs-on: ubuntu-latest
    # 'ai-copilot' ë¼ë²¨ì´ ë¶™ì€ ì´ìŠˆì—ë§Œ ì‹¤í–‰
    if: contains(github.event.issue.labels.*.name, 'ai-copilot')
    permissions:
      contents: read
      issues: write

    steps:
      - name: Assign issue to Copilot via GraphQL
        env:
          GH_TOKEN: ${{ secrets.COPILOT_ASSIGN_TOKEN }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          echo "ğŸ“‹ ì´ìŠˆ ì •ë³´"
          echo "  ë²ˆí˜¸: #${ISSUE_NUMBER}"
          echo "  ì œëª©: ${ISSUE_TITLE}"
          echo "  node_id: ${ISSUE_NODE_ID}"
          echo ""

          # 1) Copilot bot GraphQL ID ì¡°íšŒ
          echo "1ï¸âƒ£  Copilot bot ID ì¡°íšŒ ì¤‘..."
          COPILOT_BOT_ID=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GH_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection" \
            -d '{"query":"query { user(login: \"copilot\") { id } }"}' \
            | jq -r '.data.user.id // empty')

          if [ -z "$COPILOT_BOT_ID" ]; then
            echo "âŒ Copilot bot ID ì¡°íšŒ ì‹¤íŒ¨."
            echo "   Copilot Coding Agent í™œì„±í™” ì—¬ë¶€ì™€ í† í° ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          echo "   Copilot bot ID: ${COPILOT_BOT_ID}"
          echo ""

          # 2) replaceActorsForAssignableë¡œ Copilotì„ assigneeë¡œ ì„¤ì •
          echo "2ï¸âƒ£  Copilotì„ assigneeë¡œ ì„¤ì • ì¤‘..."
          ASSIGN_RESULT=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GH_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection" \
            -d "$(jq -n \
              --arg issueId "${ISSUE_NODE_ID}" \
              --arg botId "${COPILOT_BOT_ID}" \
              '{
                query: "mutation AssignIssue($issueId: ID!, $botId: ID!) { replaceActorsForAssignable(input: { assignableId: $issueId, actorIds: [$botId] }) { assignable { ... on Issue { id title assignees(first: 5) { nodes { login } } } } } }",
                variables: { issueId: $issueId, botId: $botId }
              }')")

          # ì˜¤ë¥˜ í™•ì¸
          ERRORS=$(echo "${ASSIGN_RESULT}" | jq -r '.errors[]?.message // empty')
          if [ -n "$ERRORS" ]; then
            echo "âŒ í• ë‹¹ ì‹¤íŒ¨: ${ERRORS}"
            exit 1
          fi

          ASSIGNED=$(echo "${ASSIGN_RESULT}" | jq -r '.data.replaceActorsForAssignable.assignable.assignees.nodes[].login' | tr '\n' ', ')
          echo "âœ… í• ë‹¹ ì™„ë£Œ! Assignee(s): ${ASSIGNED}"
          echo ""
          echo "  Copilotì´ ì´ìŠˆ #${ISSUE_NUMBER}ì„ ì²˜ë¦¬í•˜ê³  Draft PRì„ ìƒì„±í•©ë‹ˆë‹¤."
