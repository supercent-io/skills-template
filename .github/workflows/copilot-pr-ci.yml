# copilot-pr-ci.yml
# Copilot Coding Agentê°€ ìƒì„±í•œ PRì— ëŒ€í•œ CI ì›Œí¬í”Œë¡œ
#
# ì£¼ì˜:
#   Copilot PRì€ "ì™¸ë¶€ ê¸°ì—¬ì"ì²˜ëŸ¼ ì·¨ê¸‰ë©ë‹ˆë‹¤.
#   ì²« ë²ˆì§¸ ì‹¤í–‰ ì „ì— write ê¶Œí•œ ë³´ìœ ìì˜ ìˆ˜ë™ ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
#   ìŠ¹ì¸ í›„ ì´ CIê°€ ì •ìƒ ì‹¤í–‰ë©ë‹ˆë‹¤.
#
# planview í†µí•©:
#   CI ì‹¤íŒ¨ ì‹œ planviewë¡œ diff ê²€í†  â†’ ì½”ë©˜íŠ¸ë¡œ Copilotì— í”¼ë“œë°±

name: CI for Copilot PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  # â”€â”€â”€ ë¹Œë“œ & í…ŒìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect package manager
        id: detect-pm
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "pm=pnpm" >> $GITHUB_OUTPUT
            echo "install_cmd=pnpm install" >> $GITHUB_OUTPUT
            echo "test_cmd=pnpm test" >> $GITHUB_OUTPUT
            echo "build_cmd=pnpm build" >> $GITHUB_OUTPUT
          elif [ -f "yarn.lock" ]; then
            echo "pm=yarn" >> $GITHUB_OUTPUT
            echo "install_cmd=yarn install" >> $GITHUB_OUTPUT
            echo "test_cmd=yarn test" >> $GITHUB_OUTPUT
            echo "build_cmd=yarn build" >> $GITHUB_OUTPUT
          elif [ -f "package.json" ]; then
            echo "pm=npm" >> $GITHUB_OUTPUT
            echo "install_cmd=npm ci" >> $GITHUB_OUTPUT
            echo "test_cmd=npm test" >> $GITHUB_OUTPUT
            echo "build_cmd=npm run build" >> $GITHUB_OUTPUT
          else
            echo "pm=none" >> $GITHUB_OUTPUT
          fi

      - name: Setup pnpm
        if: steps.detect-pm.outputs.pm == 'pnpm'
        uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Setup Node.js
        if: steps.detect-pm.outputs.pm != 'none'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ steps.detect-pm.outputs.pm != 'none' && steps.detect-pm.outputs.pm || '' }}

      - name: Install dependencies
        if: steps.detect-pm.outputs.pm != 'none'
        run: ${{ steps.detect-pm.outputs.install_cmd }}

      - name: Run tests
        if: steps.detect-pm.outputs.pm != 'none'
        run: ${{ steps.detect-pm.outputs.test_cmd }} || echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì—†ìŒ ë˜ëŠ” ì‹¤íŒ¨"
        continue-on-error: true

      - name: Build
        if: steps.detect-pm.outputs.pm != 'none'
        run: ${{ steps.detect-pm.outputs.build_cmd }} || echo "âš ï¸ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"
        continue-on-error: true

  # â”€â”€â”€ PR ì •ë³´ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show changed files
        run: |
          echo "ğŸ“„ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} || true
          echo ""
          echo "ğŸ“Š ë³€ê²½ í†µê³„:"
          git diff --stat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} || true
